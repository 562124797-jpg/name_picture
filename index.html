<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒˆ é­”æ³•è¯†å­—å°æŠ¥ç”Ÿæˆå™¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* ==================== é­”æ³•é£æ ¼CSSå˜é‡ ==================== */
        :root {
            --magic-pink: #FF6B9D;
            --magic-purple: #A855F7;
            --magic-blue: #4ECDC4;
            --magic-yellow: #FFE66D;
            --magic-green: #84CC16;
            --magic-orange: #FB923C;
            --bg-gradient: linear-gradient(135deg, #FFF5F7 0%, #E8F4F8 50%, #FFF9E6 100%);
            --card-bg: #FFFFFF;
            --text-color: #4A5568;
            --text-light: #718096;
            --border-radius: 24px;
            --border-radius-sm: 16px;
            --shadow: 0 8px 30px rgba(168, 85, 247, 0.15);
            --shadow-hover: 0 12px 40px rgba(168, 85, 247, 0.25);
        }

        /* ==================== å…¨å±€æ ·å¼ ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ==================== é­”æ³•é¡¶éƒ¨æ ‡é¢˜ ==================== */
        .app-header {
            background: linear-gradient(135deg, var(--magic-pink) 0%, var(--magic-purple) 50%, var(--magic-blue) 100%);
            padding: 25px 20px;
            text-align: center;
            box-shadow: 0 8px 30px rgba(168, 85, 247, 0.3);
            position: relative;
            overflow: hidden;
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 2px, transparent 2px);
            background-size: 40px 40px;
            animation: sparkle 15s linear infinite;
        }

        @keyframes sparkle {
            0% { transform: translate(0, 0); }
            100% { transform: translate(40px, 40px); }
        }

        .app-header h1 {
            font-size: 32px;
            font-weight: 800;
            color: white;
            margin: 0;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.1);
            position: relative;
            z-index: 1;
            letter-spacing: 1px;
        }

        /* ==================== é­”æ³•å†…å®¹å¸ƒå±€ ==================== */
        .content-wrapper {
            display: flex;
            gap: 24px;
            padding: 24px;
            max-width: 1600px;
            margin: 0 auto;
            min-height: calc(100vh - 120px);
        }

        /* ==================== å·¦ä¾§æ§åˆ¶åŒº ==================== */
        .control-panel {
            width: 33.33%;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* ==================== å³ä¾§å±•ç¤ºåŒº ==================== */
        .display-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* ==================== é­”æ³•å¡ç‰‡ ==================== */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .card h3 {
            font-size: 17px;
            font-weight: 700;
            color: var(--magic-purple);
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ==================== é­”æ³•å¯†é’¥å¡ç‰‡ ==================== */
        .magic-key-card {
            background: linear-gradient(135deg, #F5F3FF 0%, #FAF5FF 100%);
            border-color: var(--magic-purple);
        }

        /* ==================== ä¸»é¢˜å¡ç‰‡ ==================== */
        .themes-card {
            background: linear-gradient(135deg, #FFF0F5 0%, #FFF5F7 100%);
            border-color: var(--magic-pink);
        }

        /* ==================== è¾“å…¥å¡ç‰‡ ==================== */
        .input-card {
            background: linear-gradient(135deg, #F0F9FF 0%, #F0FDF4 100%);
            border-color: var(--magic-blue);
        }

        /* ==================== è¿›åº¦å¡ç‰‡ ==================== */
        .progress-card {
            background: linear-gradient(135deg, #FFF9E6 0%, #FEF3C7 100%);
            border-color: var(--magic-yellow);
        }

        /* ==================== è¡¨å•æ ·å¼ ==================== */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            font-size: 14px;
            color: var(--magic-purple);
        }

        .form-group input[type="text"],
        .form-group input[type="password"] {
            width: 100%;
            padding: 12px 16px;
            border: 3px solid #E2E8F0;
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--magic-purple);
            box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.15);
            transform: scale(1.01);
        }

        .input-hint {
            display: block;
            margin-top: 5px;
            font-size: 12px;
            color: var(--text-light);
        }

        /* ==================== é­”æ³•æŒ‰é’® ==================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 14px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 12px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--magic-purple) 0%, var(--magic-pink) 100%);
            color: white;
            width: 100%;
            padding: 16px;
            font-size: 16px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(168, 85, 247, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary.loading {
            position: relative;
            color: transparent;
        }

        .btn-primary.loading::after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            top: 50%;
            left: 50%;
            margin-top: -12px;
            margin-left: -12px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn-success {
            background: linear-gradient(135deg, var(--magic-green) 0%, #22c55e 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(132, 204, 22, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%);
            color: var(--magic-blue);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #E0F2FE 0%, #BAE6FD 100%);
        }

        /* ==================== é­”æ³•ä¸»é¢˜å¡ç‰‡ ==================== */
        .magic-themes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .magic-theme-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 10px;
            background: white;
            border: 3px solid #E2E8F0;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .magic-theme-card:hover {
            transform: translateY(-3px) scale(1.02);
            border-color: var(--magic-purple);
            box-shadow: 0 8px 20px rgba(168, 85, 247, 0.2);
        }

        .magic-theme-card.selected {
            border-color: var(--magic-purple);
            background: linear-gradient(135deg, #F5F3FF 0%, #FAF5FF 100%);
            box-shadow: 0 8px 20px rgba(168, 85, 247, 0.3);
            animation: magicBounce 0.5s ease;
        }

        @keyframes magicBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .theme-icon {
            font-size: 32px;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1));
        }

        .theme-name {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-color);
        }

        /* ==================== é­”æ³•å±•ç¤ºæ¡† ==================== */
        .magic-display-frame {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 4px solid transparent;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            background: linear-gradient(135deg, #F5F3FF 0%, #FFF0F5 50%, #F0FDF4 100%);
            border-color: var(--magic-purple);
            position: relative;
        }

        .magic-display-frame::before {
            content: 'âœ¨';
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 24px;
            animation: twinkle 2s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        .display-header {
            padding: 16px 20px;
            background: linear-gradient(135deg, var(--magic-purple) 0%, var(--magic-pink) 100%);
            color: white;
            text-align: center;
            font-weight: 700;
            font-size: 16px;
        }

        .display-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: white;
            margin: 16px;
            border-radius: var(--border-radius-sm);
            border: 3px dashed #E2E8F0;
            min-height: 500px;
        }

        .display-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: var(--border-radius-sm);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .display-actions {
            padding: 16px 20px;
            display: flex;
            gap: 12px;
            justify-content: center;
            background: linear-gradient(135deg, #FFF9E6 0%, #FEF3C7 100%);
        }

        .display-actions .btn {
            flex: 1;
            max-width: 200px;
        }

        /* ==================== é­”æ³•è¿›åº¦ ==================== */
        .magic-steps {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .magic-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: white;
            border-radius: var(--border-radius-sm);
            border: 3px solid #E2E8F0;
            transition: all 0.3s ease;
        }

        .step-icon {
            font-size: 20px;
            min-width: 28px;
            text-align: center;
        }

        .step-text {
            flex: 1;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
        }

        .step-status {
            font-size: 20px;
        }

        .magic-step.completed {
            background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
            border-color: var(--magic-green);
        }

        .magic-step.completed .step-status::after {
            content: 'âœ¨';
            color: var(--magic-green);
            font-weight: bold;
        }

        .magic-step.in_progress {
            background: linear-gradient(135deg, #F5F3FF 0%, #EDE9FE 100%);
            border-color: var(--magic-purple);
            animation: magicPulse 1.5s ease-in-out infinite;
        }

        .magic-step.in_progress .step-status::after {
            content: 'ğŸ”®';
        }

        @keyframes magicPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .magic-step.pending {
            opacity: 0.5;
        }

        .magic-step.pending .step-status::after {
            content: 'â­•';
            color: #CBD5E0;
        }

        /* ==================== é­”æ³•è¿›åº¦æ¡ ==================== */
        .magic-progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 14px;
        }

        .magic-progress-bar {
            flex: 1;
            height: 14px;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            border: 3px solid #E2E8F0;
        }

        .magic-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--magic-purple) 0%, var(--magic-pink) 50%, var(--magic-blue) 100%);
            background-size: 200% 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            width: 0%;
            animation: magicShimmer 2s linear infinite;
        }

        @keyframes magicShimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .progress-text {
            font-size: 16px;
            font-weight: 800;
            color: var(--magic-purple);
            min-width: 45px;
            text-align: right;
        }

        /* ==================== é­”æ³•æç¤º ==================== */
        .magic-note {
            padding: 12px;
            background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
            border-radius: var(--border-radius-sm);
            margin-top: 12px;
            border: 2px dashed var(--magic-orange);
        }

        .magic-note p {
            margin: 0;
            font-size: 12px;
            color: #92400E;
            font-weight: 600;
        }

        /* ==================== é­”æ³•Toast ==================== */
        .magic-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: var(--border-radius-sm);
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            animation: magicSlideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 380px;
            border: 3px solid;
        }

        @keyframes magicSlideIn {
            from {
                transform: translateX(120%) rotate(-10deg);
                opacity: 0;
            }
            to {
                transform: translateX(0) rotate(0);
                opacity: 1;
            }
        }

        .magic-toast.success {
            background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%);
            border-color: var(--magic-green);
            color: #166534;
        }

        .magic-toast.error {
            background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%);
            border-color: #EF4444;
            color: #991B1B;
        }

        .toast-icon {
            font-size: 22px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            font-weight: 600;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: inherit;
            padding: 0;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .toast-close:hover {
            background: rgba(0,0,0,0.1);
        }

        /* ==================== é­”æ³•è£…é¥° ==================== */
        .magic-decoration {
            position: fixed;
            font-size: 36px;
            opacity: 0.25;
            pointer-events: none;
            z-index: -1;
        }

        .magic-decoration-1 { top: 12%; left: 3%; animation: floatMagic1 6s ease-in-out infinite; }
        .magic-decoration-2 { top: 25%; right: 6%; animation: floatMagic2 8s ease-in-out infinite; }
        .magic-decoration-3 { bottom: 15%; left: 8%; animation: floatMagic3 7s ease-in-out infinite; }
        .magic-decoration-4 { bottom: 30%; right: 4%; animation: floatMagic1 9s ease-in-out infinite; }

        @keyframes floatMagic1 {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }

        @keyframes floatMagic2 {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(-5deg); }
        }

        @keyframes floatMagic3 {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-25px) scale(1.1); }
        }

        /* ==================== å“åº”å¼ ==================== */
        @media (max-width: 1024px) {
            .content-wrapper {
                flex-direction: column;
            }

            .control-panel {
                width: 100%;
            }

            .magic-themes {
                grid-template-columns: repeat(5, 1fr);
            }

            .display-content {
                min-height: 350px;
            }
        }

        @media (max-width: 640px) {
            .app-header h1 {
                font-size: 22px;
            }

            .content-wrapper {
                padding: 12px;
            }

            .magic-themes {
                grid-template-columns: repeat(3, 1fr);
            }

            .display-actions {
                flex-direction: column;
            }

            .display-actions .btn {
                max-width: none;
            }

            .magic-decoration {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- é­”æ³•è£…é¥° -->
    <div class="magic-decoration magic-decoration-1">âœ¨</div>
    <div class="magic-decoration magic-decoration-2">ğŸ”®</div>
    <div class="magic-decoration magic-decoration-3">â­</div>
    <div class="magic-decoration magic-decoration-4">ğŸŒŸ</div>

    <div class="app-container">
        <!-- é­”æ³•æ ‡é¢˜ -->
        <header class="app-header">
            <h1>ğŸ”® é­”æ³•è¯†å­—å°æŠ¥ç”Ÿæˆå™¨ âœ¨</h1>
        </header>

        <!-- é­”æ³•å†…å®¹ -->
        <div class="content-wrapper">
            <!-- å·¦ä¾§æ§åˆ¶åŒº -->
            <aside class="control-panel">
                <!-- é­”æ³•å¯†é’¥ -->
                <div class="card magic-key-card">
                    <h3>ğŸ”‘ é­”æ³•å¯†é’¥</h3>

                    <div class="form-group">
                        <label for="imageApiKey">ç”»ç¬”å¯†é’¥</label>
                        <input type="password" id="imageApiKey" placeholder="è¾“å…¥ä½ çš„é­”æ³•å¯†é’¥..." autocomplete="off">
                        <div style="margin-top: 8px; display: flex; gap: 10px; align-items: center;">
                            <button id="btnSaveImageKey" class="btn btn-sm btn-secondary">âœ¨ ä¿å­˜</button>
                            <span id="imageKeyStatus" class="input-hint"></span>
                        </div>
                    </div>

                    <div class="magic-note">
                        <p>ğŸ”® å¯†é’¥ä¼šä¿å­˜åœ¨é­”æ³•ä¹¦é‡Œï¼Œä¸‹æ¬¡ä¸ç”¨é‡æ–°è¾“å…¥å“¦~</p>
                    </div>
                </div>

                <!-- é€‰æ‹©ä¸»é¢˜ -->
                <div class="card themes-card">
                    <h3>ğŸ“– é€‰æ‹©é­”æ³•ä¸»é¢˜</h3>
                    <div class="magic-themes" id="presetThemes">
                        <!-- JSç”Ÿæˆ -->
                    </div>
                </div>

                <!-- å¡«å†™ä¿¡æ¯ -->
                <div class="card input-card">
                    <h3>ğŸª„ é­”æ³•å’’è¯­</h3>

                    <div class="form-group">
                        <label for="theme">ğŸ¯ é­”æ³•åœºæ™¯</label>
                        <input type="text" id="theme" placeholder="æ¯”å¦‚ï¼šè¶…å¸‚ã€åŒ»é™¢ã€å…¬å›­...">
                        <small class="input-hint">è¯´å‡ºä½ æƒ³è¦æ–½å±•é­”æ³•çš„åœ°æ–¹å§~</small>
                    </div>

                    <div class="form-group">
                        <label for="title">ğŸ“œ å°æŠ¥æ ‡é¢˜</label>
                        <input type="text" id="title" placeholder="æ¯”å¦‚ï¼šã€Šèµ°è¿›è¶…å¸‚ã€‹ã€Šå¿«ä¹åŒ»é™¢ã€‹">
                        <small class="input-hint">ç»™å°æŠ¥èµ·ä¸€ä¸ªç¥å¥‡çš„åå­—å§~</small>
                    </div>

                    <div style="margin-top: 16px;">
                        <button id="btnGenerate" class="btn btn-primary" disabled>
                            ğŸª„ æ–½å±•é­”æ³•ï¼
                        </button>
                    </div>
                </div>

                <!-- é­”æ³•è¿›åº¦ -->
                <div class="card progress-card">
                    <h3>âš¡ é­”æ³•è¿›ç¨‹</h3>

                    <div class="magic-steps">
                        <div class="magic-step pending" id="step1">
                            <span class="step-icon">1ï¸âƒ£</span>
                            <span class="step-text">å‡†å¤‡é­”æ³•å’’è¯­</span>
                            <span class="step-status"></span>
                        </div>
                        <div class="magic-step pending" id="step2">
                            <span class="step-icon">2ï¸âƒ£</span>
                            <span class="step-text">æ–½å±•ç»˜ç”»é­”æ³•</span>
                            <span class="step-status"></span>
                        </div>
                        <div class="magic-step pending" id="step3">
                            <span class="step-icon">3ï¸âƒ£</span>
                            <span class="step-text">ç­‰å¾…é­”æ³•å®Œæˆ</span>
                            <span class="step-status"></span>
                        </div>
                    </div>

                    <div class="magic-progress-container">
                        <div class="magic-progress-bar">
                            <div class="magic-progress-fill" id="progressFill"></div>
                        </div>
                        <span class="progress-text" id="progressText">0%</span>
                    </div>
                </div>
            </aside>

            <!-- å³ä¾§å±•ç¤ºåŒº -->
            <main class="display-panel">
                <div class="magic-display-frame">
                    <div class="display-header">
                        âœ¨ ä½ çš„é­”æ³•å°æŠ¥ âœ¨
                    </div>
                    <div class="display-content" id="resultContainer">
                        <img id="displayImage" class="display-image" src="https://images.unsplash.com/photo-1503676260728-1c00da094a0b?w=800&h=1000&fit=crop" alt="é­”æ³•å°æŠ¥">
                    </div>
                    <div class="display-actions" id="resultActions">
                        <button id="btnDownload" class="btn btn-success">
                            â¬‡ï¸ æ”¶è—é­”æ³•
                        </button>
                        <button id="btnRegenerate" class="btn btn-secondary">
                            ğŸ”„ é‡æ–°æ–½å±•
                        </button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toastå®¹å™¨ -->
    <div id="toastContainer"></div>

    <script>
        // ==================== é¢„è®¾ä¸»é¢˜æ•°æ® ====================
        const PRESET_THEMES = [
            { theme: 'è¶…å¸‚', icon: 'ğŸ›’', title: 'ã€Šèµ°è¿›è¶…å¸‚ã€‹' },
            { theme: 'åŒ»é™¢', icon: 'ğŸ¥', title: 'ã€Šå¿«ä¹åŒ»é™¢ã€‹' },
            { theme: 'å…¬å›­', icon: 'ğŸŒ³', title: 'ã€Šç¾ä¸½çš„å…¬å›­ã€‹' },
            { theme: 'å­¦æ ¡', icon: 'ğŸ«', title: 'ã€Šæˆ‘çš„å­¦æ ¡ã€‹' },
            { theme: 'åŠ¨ç‰©å›­', icon: 'ğŸ¦', title: 'ã€ŠåŠ¨ç‰©å›­ä¸€æ—¥æ¸¸ã€‹' },
            { theme: 'å›¾ä¹¦é¦†', icon: 'ğŸ“š', title: 'ã€Šå›¾ä¹¦é¦†é‡Œã€‹' },
            { theme: 'æ¶ˆé˜²ç«™', icon: 'ğŸš’', title: 'ã€Šå°å°æ¶ˆé˜²å‘˜ã€‹' },
            { theme: 'é¤å…', icon: 'ğŸ½ï¸', title: 'ã€Šç¾é£Ÿé¤å…ã€‹' },
            { theme: 'è­¦å¯Ÿå±€', icon: 'ğŸ‘®', title: 'ã€Šè­¦å¯Ÿå±€ã€‹' },
            { theme: 'é‚®å±€', icon: 'ğŸ“®', title: 'ã€Šé‚®å±€é€ä¿¡ã€‹' }
        ];

        // ==================== é…ç½®ç®¡ç† ====================
        class ConfigManager {
            static STORAGE_KEY = 'magic_literacy_image_api_key';

            static saveApiKey(key) {
                try {
                    localStorage.setItem(this.STORAGE_KEY, key);
                    return true;
                } catch (error) {
                    console.error('ä¿å­˜å¤±è´¥:', error);
                    return false;
                }
            }

            static getApiKey() {
                return localStorage.getItem(this.STORAGE_KEY);
            }

            static isConfigured() {
                return !!this.getApiKey();
            }
        }

        // ==================== æç¤ºè¯æ„å»º ====================
        class PromptBuilder {
            buildPrompt(theme, title) {
                return `è¯·ç”Ÿæˆä¸€å¼ å„¿ç«¥è¯†å­—å°æŠ¥ã€Š${theme}ã€‹ï¼Œç«–ç‰ˆ A4ï¼Œå­¦ä¹ å°æŠ¥ç‰ˆå¼ï¼Œé€‚åˆ 5â€“9 å²å­©å­ è®¤å­—ä¸çœ‹å›¾è¯†ç‰©ã€‚

# ä¸€ã€å°æŠ¥æ ‡é¢˜åŒºï¼ˆé¡¶éƒ¨ï¼‰

**é¡¶éƒ¨å±…ä¸­å¤§æ ‡é¢˜**ï¼šã€Š${title}ã€‹
* **é£æ ¼**ï¼šåå­—å°æŠ¥ / å„¿ç«¥å­¦ä¹ æŠ¥æ„Ÿ
* **æ–‡æœ¬è¦æ±‚**ï¼šå¤§å­—ã€é†’ç›®ã€å¡é€šæ‰‹å†™ä½“ã€å½©è‰²æè¾¹
* **è£…é¥°**ï¼šå‘¨å›´æ·»åŠ ä¸ ${theme} ç›¸å…³çš„è´´çº¸é£è£…é¥°ï¼Œé¢œè‰²é²œè‰³

# äºŒã€å°æŠ¥ä¸»ä½“ï¼ˆä¸­é—´ä¸»ç”»é¢ï¼‰

ç”»é¢ä¸­å¿ƒæ˜¯ä¸€å¹… **å¡é€šæ’ç”»é£çš„ã€Œ${theme}ã€åœºæ™¯**ï¼š
* **æ•´ä½“æ°”æ°›**ï¼šæ˜äº®ã€æ¸©æš–ã€ç§¯æ
* **æ„å›¾**ï¼šç‰©ä½“è¾¹ç•Œæ¸…æ™°ï¼Œæ–¹ä¾¿å¯¹åº”æ–‡å­—ï¼Œä¸è¦è¿‡äºæ‹¥æŒ¤ã€‚

**åœºæ™¯åˆ†åŒºä¸æ ¸å¿ƒå†…å®¹**
1.  **æ ¸å¿ƒåŒºåŸŸ Aï¼ˆä¸»è¦å¯¹è±¡ï¼‰**ï¼šè¡¨ç° ${theme} çš„æ ¸å¿ƒæ´»åŠ¨ã€‚
2.  **æ ¸å¿ƒåŒºåŸŸ Bï¼ˆé…å¥—è®¾æ–½ï¼‰**ï¼šå±•ç¤ºç›¸å…³çš„å·¥å…·æˆ–ç‰©å“ã€‚
3.  **æ ¸å¿ƒåŒºåŸŸ Cï¼ˆç¯å¢ƒèƒŒæ™¯ï¼‰**ï¼šä½“ç°ç¯å¢ƒç‰¹å¾ï¼ˆå¦‚å¢™é¢ã€æŒ‡ç¤ºç‰Œç­‰ï¼‰ã€‚

**ä¸»é¢˜äººç‰©**
* **è§’è‰²**ï¼š1 ä½å¯çˆ±å¡é€šäººç‰©ï¼ˆèŒä¸š/èº«ä»½ï¼šä¸ ${theme} åŒ¹é…ï¼‰ã€‚
* **åŠ¨ä½œ**ï¼šæ­£åœ¨è¿›è¡Œä¸åœºæ™¯ç›¸å…³çš„è‡ªç„¶äº’åŠ¨ã€‚

# ä¸‰ã€å¿…ç”»ç‰©ä½“ä¸è¯†å­—æ¸…å•

**è¯·æ ¹æ®ã€Œ${theme}ã€ä¸»é¢˜ï¼Œè‡ªåŠ¨è”æƒ³15-20ä¸ªé€‚åˆå„¿ç«¥è¯†å­—çš„è¯æ±‡ï¼ˆåŒ…å«æ ¸å¿ƒè§’è‰²ä¸è®¾æ–½ã€å¸¸è§ç‰©å“/å·¥å…·ã€ç¯å¢ƒä¸è£…é¥°ï¼‰ï¼Œå¹¶ä¸ºæ¯ä¸ªç‰©ä½“è´´ä¸Šä¸­æ–‡è¯†å­—æ ‡ç­¾ã€‚**

è¯†å­—æ ‡ç­¾æ ¼å¼ï¼š
* **æ ¼å¼**ï¼šä¸¤è¡Œåˆ¶ï¼ˆç¬¬ä¸€è¡Œæ‹¼éŸ³å¸¦å£°è°ƒï¼Œç¬¬äºŒè¡Œç®€ä½“æ±‰å­—ï¼‰ã€‚
* **æ ·å¼**ï¼šå½©è‰²å°è´´çº¸é£æ ¼ï¼Œç™½åº•é»‘å­—æˆ–æ·±è‰²å­—ï¼Œæ¸…æ™°å¯è¯»ã€‚
* **æ’ç‰ˆ**ï¼šæ ‡ç­¾é è¿‘å¯¹åº”çš„ç‰©ä½“ï¼Œä¸é®æŒ¡ä¸»ä½“ã€‚

# å››ã€ç”»é£å‚æ•°
* **é£æ ¼**ï¼šå„¿ç«¥ç»˜æœ¬é£ + è¯†å­—å°æŠ¥é£
* **è‰²å½©**ï¼šé«˜é¥±å’Œã€æ˜å¿«ã€æ¸©æš– (High Saturation, Warm Tone)
* **è´¨é‡**ï¼š8k resolution, high detail, vector illustration style, clean lines.`;
            }
        }

        // ==================== å›¾ç‰‡ç”Ÿæˆ ====================
        class ImageGenerator {
            constructor(apiKey) {
                this.apiKey = apiKey;
                this.baseUrl = 'https://api.kie.ai/api/v1/jobs';
            }

            async createTask(prompt) {
                const requestBody = {
                    model: 'nano-banana-pro',
                    input: {
                        prompt: prompt,
                        image_input: [],
                        aspect_ratio: '3:4',
                        resolution: '4K',
                        output_format: 'png'
                    }
                };

                try {
                    const response = await fetch(`${this.baseUrl}/createTask`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.msg || `è¯·æ±‚å¤±è´¥: ${response.status}`);
                    }

                    const data = await response.json();

                    return {
                        success: true,
                        taskId: data.data.taskId
                    };

                } catch (error) {
                    console.error('åˆ›å»ºä»»åŠ¡å¤±è´¥:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }

            async queryTaskStatus(taskId) {
                try {
                    const response = await fetch(
                        `${this.baseUrl}/recordInfo?taskId=${encodeURIComponent(taskId)}`,
                        {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${this.apiKey}`
                            }
                        }
                    );

                    if (!response.ok) {
                        throw new Error(`æŸ¥è¯¢å¤±è´¥: ${response.status}`);
                    }

                    const data = await response.json();

                    return {
                        success: true,
                        state: data.data.state,
                        resultJson: data.data.resultJson,
                        failCode: data.data.failCode,
                        failMsg: data.data.failMsg
                    };

                } catch (error) {
                    console.error('æŸ¥è¯¢å¤±è´¥:', error);
                    return {
                        success: false,
                        error: error.message
                    };
                }
            }

            extractImageUrl(resultJson) {
                try {
                    const result = JSON.parse(resultJson);
                    if (result.resultUrls && result.resultUrls.length > 0) {
                        return result.resultUrls[0];
                    }
                    return null;
                } catch (error) {
                    console.error('è§£æç»“æœå¤±è´¥:', error);
                    return null;
                }
            }
        }

        // ==================== ä»»åŠ¡è½®è¯¢ ====================
        class TaskPoller {
            constructor(imageGenerator) {
                this.imageGenerator = imageGenerator;
                this.pollInterval = 3000;
                this.maxAttempts = 60;
                this.currentPollId = 0;
            }

            async pollTask(taskId, onProgress, onComplete, onError) {
                const pollId = ++this.currentPollId;
                let attempts = 0;

                onProgress(5, 'é­”æ³•å¼€å§‹...');

                const poll = async () => {
                    if (pollId !== this.currentPollId) {
                        return;
                    }

                    attempts++;

                    try {
                        const result = await this.imageGenerator.queryTaskStatus(taskId);

                        if (!result.success) {
                            onError(result.error);
                            return;
                        }

                        const progress = Math.min(5 + (attempts / this.maxAttempts) * 90, 95);

                        switch (result.state) {
                            case 'waiting':
                                if (attempts >= this.maxAttempts) {
                                    onError('é­”æ³•éœ€è¦å¤ªä¹…å•¦ï¼Œå†è¯•ä¸€æ¬¡å§~');
                                    return;
                                }
                                onProgress(progress, `é­”æ³•æ–½å±•ä¸­... ${attempts}`);
                                setTimeout(poll, this.pollInterval);
                                break;

                            case 'success':
                                const imageUrl = this.imageGenerator.extractImageUrl(result.resultJson);
                                if (imageUrl) {
                                    onProgress(100, 'é­”æ³•å®Œæˆï¼');
                                    onComplete(imageUrl);
                                } else {
                                    onError('é­”æ³•å¥½åƒå¤±æ•ˆäº†~');
                                }
                                break;

                            case 'fail':
                                onError(result.failMsg || 'é­”æ³•æ–½å±•å¤±è´¥å•¦~');
                                break;
                        }

                    } catch (error) {
                        onError(error.message);
                    }
                };

                await poll();
            }

            cancel() {
                this.currentPollId++;
            }
        }

        // ==================== Toasté€šçŸ¥ ====================
        class Toast {
            static show(message, type = 'success', duration = 3000) {
                const toast = document.createElement('div');
                toast.className = `magic-toast ${type}`;
                toast.innerHTML = `
                    <span class="toast-icon">${type === 'success' ? 'âœ¨' : 'ğŸ˜¢'}</span>
                    <span class="toast-message">${this._escapeHtml(message)}</span>
                    <button class="toast-close">Ã—</button>
                `;

                document.getElementById('toastContainer').appendChild(toast);

                const timeout = setTimeout(() => {
                    this._removeToast(toast);
                }, duration);

                toast.querySelector('.toast-close').addEventListener('click', () => {
                    clearTimeout(timeout);
                    this._removeToast(toast);
                });
            }

            static success(message, duration) {
                this.show(message, 'success', duration);
            }

            static error(message, duration) {
                this.show(message, 'error', duration || 5000);
            }

            static _removeToast(toast) {
                toast.style.animation = 'magicSlideIn 0.3s reverse';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }

            static _escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // ==================== ä¸»æ§åˆ¶å™¨ ====================
        class AppController {
            constructor() {
                this.promptBuilder = new PromptBuilder();
                this.imageGenerator = null;
                this.taskPoller = null;
                this.currentImageUrl = null;

                this._initializeUI();
                this._loadSavedApiKey();
                this._bindEvents();
                this._checkGenerateButton();
            }

            _initializeUI() {
                this.ui = {
                    themeInput: document.getElementById('theme'),
                    titleInput: document.getElementById('title'),
                    imageApiKeyInput: document.getElementById('imageApiKey'),
                    presetThemes: document.getElementById('presetThemes'),
                    generateBtn: document.getElementById('btnGenerate'),
                    downloadBtn: document.getElementById('btnDownload'),
                    regenerateBtn: document.getElementById('btnRegenerate'),
                    displayImage: document.getElementById('displayImage'),
                    progressFill: document.getElementById('progressFill'),
                    progressText: document.getElementById('progressText'),
                    btnSaveImageKey: document.getElementById('btnSaveImageKey'),
                    imageKeyStatus: document.getElementById('imageKeyStatus')
                };

                this._renderPresetThemes();
            }

            _renderPresetThemes() {
                this.ui.presetThemes.innerHTML = PRESET_THEMES.map(preset => `
                    <div class="magic-theme-card" data-theme="${preset.theme}" data-title="${preset.title}">
                        <span class="theme-icon">${preset.icon}</span>
                        <span class="theme-name">${preset.theme}</span>
                    </div>
                `).join('');
            }

            _loadSavedApiKey() {
                const imageKey = ConfigManager.getApiKey();

                if (imageKey) {
                    this.ui.imageApiKeyInput.value = imageKey;
                    this.ui.imageKeyStatus.textContent = 'âœ… å·²ä¿å­˜';
                    this.ui.imageKeyStatus.style.color = 'var(--magic-green)';
                }

                this._initializeServices();
            }

            _initializeServices() {
                const imageApiKey = ConfigManager.getApiKey();

                if (imageApiKey) {
                    this.imageGenerator = new ImageGenerator(imageApiKey);
                    this.taskPoller = new TaskPoller(this.imageGenerator);
                }

                this._checkGenerateButton();
            }

            _bindEvents() {
                // API Keyä¿å­˜
                this.ui.btnSaveImageKey.addEventListener('click', () => {
                    const key = this.ui.imageApiKeyInput.value.trim();
                    if (key.length < 10) {
                        Toast.error('å¯†é’¥æ ¼å¼å¥½åƒä¸å¯¹å“¦~');
                        return;
                    }
                    if (ConfigManager.saveApiKey(key)) {
                        this.ui.imageKeyStatus.textContent = 'âœ… å·²ä¿å­˜';
                        this.ui.imageKeyStatus.style.color = 'var(--magic-green)';
                        Toast.success('é­”æ³•å¯†é’¥ä¿å­˜æˆåŠŸå•¦ï¼');
                        this._initializeServices();
                    }
                });

                // é¢„è®¾ä¸»é¢˜ç‚¹å‡»
                this.ui.presetThemes.addEventListener('click', (e) => {
                    const card = e.target.closest('.magic-theme-card');
                    if (card) {
                        document.querySelectorAll('.magic-theme-card').forEach(c => c.classList.remove('selected'));
                        card.classList.add('selected');

                        this.ui.themeInput.value = card.dataset.theme;
                        this.ui.titleInput.value = card.dataset.title;
                        this._checkGenerateButton();
                    }
                });

                // è¾“å…¥æ¡†å˜åŒ–
                this.ui.themeInput.addEventListener('input', () => this._checkGenerateButton());
                this.ui.titleInput.addEventListener('input', () => this._checkGenerateButton());

                // ç”ŸæˆæŒ‰é’®
                this.ui.generateBtn.addEventListener('click', () => this.generateNewsletter());

                // ä¸‹è½½æŒ‰é’®
                this.ui.downloadBtn.addEventListener('click', () => this.downloadImage());

                // é‡æ–°ç”ŸæˆæŒ‰é’®
                this.ui.regenerateBtn.addEventListener('click', () => this.generateNewsletter());
            }

            _checkGenerateButton() {
                const hasTheme = this.ui.themeInput.value.trim().length > 0;
                const hasTitle = this.ui.titleInput.value.trim().length > 0;
                const hasConfig = ConfigManager.isConfigured();
                this.ui.generateBtn.disabled = !(hasTheme && hasTitle && hasConfig);
            }

            _updateStepStatus(stepNum, status) {
                const step = document.getElementById(`step${stepNum}`);
                step.className = `magic-step ${status}`;
            }

            _updateProgress(progress, message) {
                this.ui.progressFill.style.width = `${progress}%`;
                this.ui.progressText.textContent = `${Math.round(progress)}%`;
            }

            _resetAllSteps() {
                for (let i = 1; i <= 3; i++) {
                    this._updateStepStatus(i, 'pending');
                }
                this._updateProgress(0, '');
            }

            _displayResult(imageUrl) {
                this.currentImageUrl = imageUrl;
                this.ui.displayImage.src = imageUrl;
            }

            async generateNewsletter() {
                const theme = this.ui.themeInput.value.trim();
                const title = this.ui.titleInput.value.trim();

                if (!theme || !title) {
                    Toast.error('è¯·æŠŠé­”æ³•åœºæ™¯å’Œæ ‡é¢˜éƒ½å¡«ä¸Šå“¦~');
                    return;
                }

                this.ui.generateBtn.disabled = true;
                this.ui.generateBtn.classList.add('loading');
                this._resetAllSteps();

                try {
                    // Step 1: æ‹¼æ¥æç¤ºè¯
                    this._updateStepStatus(1, 'in_progress');
                    const fullPrompt = this.promptBuilder.buildPrompt(theme, title);
                    this._updateStepStatus(1, 'completed');

                    // Step 2: åˆ›å»ºå›¾ç‰‡ç”Ÿæˆä»»åŠ¡
                    this._updateStepStatus(2, 'in_progress');
                    const taskResult = await this.imageGenerator.createTask(fullPrompt);

                    if (!taskResult.success) {
                        throw new Error(`åˆ›å»ºä»»åŠ¡å¤±è´¥: ${taskResult.error}`);
                    }

                    this._updateStepStatus(2, 'completed');

                    // Step 3: è½®è¯¢ç­‰å¾…å›¾ç‰‡ç”Ÿæˆ
                    this._updateStepStatus(3, 'in_progress');

                    await this.taskPoller.pollTask(
                        taskResult.taskId,
                        (progress, message) => {
                            this._updateProgress(progress, message);
                        },
                        (imageUrl) => {
                            this._updateStepStatus(3, 'completed');
                            this._displayResult(imageUrl);
                            this.ui.generateBtn.disabled = false;
                            this.ui.generateBtn.classList.remove('loading');
                            Toast.success('é­”æ³•å°æŠ¥ç”Ÿæˆå¥½å•¦ï¼');
                        },
                        (error) => {
                            throw new Error(error);
                        }
                    );

                } catch (error) {
                    console.error('ç”Ÿæˆå¤±è´¥:', error);
                    Toast.error(error.message);
                    this.ui.generateBtn.disabled = false;
                    this.ui.generateBtn.classList.remove('loading');
                    this._resetAllSteps();
                }
            }

            async downloadImage() {
                if (!this.currentImageUrl) {
                    Toast.error('æ²¡æœ‰å¯æ”¶è—çš„é­”æ³•å°æŠ¥å“¦~');
                    return;
                }

                try {
                    const response = await fetch(this.currentImageUrl);
                    const blob = await response.blob();

                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `é­”æ³•è¯†å­—å°æŠ¥_${Date.now()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    Toast.success('é­”æ³•å°æŠ¥æ”¶è—æˆåŠŸï¼');
                } catch (error) {
                    console.error('ä¸‹è½½å¤±è´¥:', error);
                    Toast.error('æ”¶è—å¤±è´¥: ' + error.message);
                }
            }
        }

        // ==================== åˆå§‹åŒ–åº”ç”¨ ====================
        document.addEventListener('DOMContentLoaded', () => {
            new AppController();
        });
    </script>
</body>
</html>
